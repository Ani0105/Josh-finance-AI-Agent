[MERGED CODE OMITTED HERE FOR BREVITY â€” will paste in full in actual upload]